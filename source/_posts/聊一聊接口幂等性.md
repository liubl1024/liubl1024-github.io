---
title: 聊一聊接口幂等性
date: 2021-02-08 23:19:55
tags:
---
回想曾经刚来北京，去某厂面试，前面聊得还不错，后面突然被问到幂等性问题，当时从二线城市出来，完全没听过这个名词有点懵，没答上来，明显感觉面试官态度有所变化。面试结束后一查才知道，平时开发过程中防止用户重复点击等场景，其实已经用到过就是不知道这个名词。

幂等性其实就是多次调用接口返回值和影响结果与单次调用的返回值和影响相同。

拿类似微博的系统来说，如果查看某个人的微博，查询一次和查询多次结果是一样的，并且都不会影响数据库中关于这条微博的存储结果。

因此可以说，查询天生就是幂等性的， 在 `Restful` 中 即  GET 是幂等性。

```bash
GET  http://somesite.com/?id=1    # 多次调用 对后端无影响
```



如果作为用户，发一条微博，由于手抖或者网络波动重试而发出去了多条相同的微博，那么此时肯定不是我们想要的结果，所以新增不是幂等性的。

```bash
POST   http://somesite.com/weibo     # 多次调用会生成多条记录
```



修改和删除也类似，加入某个用户要加经验或金币，一般不会用  update set 具体值操作，而是使用  += ，那么多次修改金币或经验数肯定对不上了。



删除虽说 一般标记 状态 ` is_del  = true`  的假删除  ，但是对同一 id 多次请求 `DELETE`  返回结果可能是不一样的。



#### 解决

其实解决办法基本上都能想到，就是用  token 或叫做 noceid 的字符串来标记请求，如果第一次处理成功就记录 token 和返回结果，如果处理失败就立即删除 token ，后面如果有相同 token 和参数的请求就直接返回 记录的结果。token 最好客户端生成，因为服务端很难区分是真实的需要新增或修改多条数据还是由于某些原因重复发送的数据



生成 token 得注意：

token 尽可能**唯一**， token 一般是客户端生成，因此可以利用客户端的信息元素 加时间戳等 算法来保证唯一


一般来说用 redis 来存储比较合适，因为 redis 是单线程，第一个请求到来后，可以马上把 token 放到 `string` 中存储，系统开销也会较小。



几个常用 设计幂等操作的方法

1. 利用数据库的唯一约束实现

    mysql    insert if not exist

    redis   setnx 代替

2. 为更新的数据设置前置条件

    “将账户 X 的余额增加 100 元”这个操作并不满足幂等性，我们可以把这个操作加上一个前置条件，变为：“如果账户 X 当前的余额为 500 元，将余额加 100 元”，这个操作就具备了幂等性

    例如更新前  查询 select   ...  for update

    数据增加版本号属性 

3. 记录并检查操作

    也称为“Token 机制或者 GUID（全局唯一 ID）机制”，实现的思路特别简单：在执行数据更新操作之前，先检查一下是否执行过这个更新操作

    记录并检查操作，在每个消息中维护一个全局唯一的ID，根据全局唯一ID进行判断消息是否已经被消费。存在的问题，全局唯一ID的实现有一定的复杂度，需要确保检查消费状态、更新数据、以及更新消费状态三个操作原子性，解决方式涉及到分布式锁和分布式事务，并且对高性能、高并发也有一定的影响